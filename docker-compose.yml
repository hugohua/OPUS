version: '3.8'

services:
  opus-db:
    image: ankane/pgvector:latest
    container_name: opus-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: opus
    ports:
      - "5432:5432"
    volumes:
      # è¿™é‡Œå¼•ç”¨ä¸‹é¢å®šä¹‰çš„å¤–éƒ¨å·
      - opus_data:/var/lib/postgresql/data

  opus-redis:
    image: redis:7-alpine
    container_name: opus-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - opus_redis_data:/data
    command: redis-server --appendonly yes

  opus-worker:
    image: node:20-alpine
    container_name: opus-worker
    working_dir: /app
    volumes:
      - .:/app # æŒ‚è½½é¡¹ç›®æ ¹ç›®å½•ï¼Œæ”¯æŒçƒ­æ›´æ–°
    command: npx tsx --watch workers/index.ts
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@opus-db:5432/opus
      - REDIS_URL=redis://opus-redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - AI_MODEL_NAME=${AI_MODEL_NAME}
      - ETL_API_KEY=${ETL_API_KEY}
      - ETL_BASE_URL=${ETL_BASE_URL}
      - AI_PROVIDER_ORDER=${AI_PROVIDER_ORDER}
    depends_on:
      - opus-db
      - opus-redis

  opus-tts:
    build: ./python_tts_service
    container_name: opus-tts
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
    volumes:
      - ./public/audio:/app/audio # å…±äº«éŸ³é¢‘ç›®å½•åˆ° Next.js public ç›®å½•
    depends_on:
      - opus-db
      - opus-redis

volumes:
  # ğŸ”¥ å…³é”®ï¼šå‘Šè¯‰ Compose è¿™ä¸ªå·æ˜¯å¤–é¢å·²ç»å»ºå¥½çš„
  opus_data:
    external: true
    # Redis å·æ˜¯æ–°çš„ï¼Œå¯ä»¥ç”± Compose ç®¡ç†

  opus_redis_data:
