generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vocab {
  // 1. 核心标识
  id               Int      @id @default(autoincrement())
  word             String   @unique

  // 2. 基础语料 (From Oxford 5000)
  phoneticUk       String?  // 英式音标
  phoneticUs       String?  // 美式音标
  audioUk          String?  // 英式音频 URL
  partOfSpeech     String?  // 词性
  commonExample    String?  // 通用例句
  
  // 3. 语义与场景 (AI 增强)
  // [关键] 卡片式 UI 专用的简明中文释义 (从 JP 或 EN 翻译而来)
  // 示例: "抛弃；中止"
  definition_cn    String?  

  // definitions 结构: [{type: 'general', text: '...'}, {type: 'business', text: '...'}]
  // [关键] 结构化释义 (详情页用)
  // 结构: { "business_cn": "会议记录", "general_cn": "分钟" }
  definitions      Json?     
  
  // [关键] 商务属性开关 (用于 Sidebar 筛选 "Business Only")
  is_toeic_core    Boolean  @default(false)

  scenarios        String[] // 商务场景标签 (AI Cleaned)
  
  // collocations 结构: [{text: '...', trans: '...', source: 'abceed', weight: 100}]
  collocations     Json?     // 常用搭配 (AI Generated / Abceed)
  
  // 3.1 AI 增强 Pro Max (ETL V3.0)
  priority         VocabPriority? // 优先级 (CORE: 核心商务词, SUPPORT: 支撑词, NOISE: 简单词)
  word_family      Json?          // 词族变形 { n: "...", v: "..." }
  confusing_words  String[]       // 易混淆词 (Malapropisms)
  synonyms         String[]       // 商务近义词
  
  tags             String[] // 自动标签 (e.g. toeic_900)
  
  // 4. 元数据
  source           String   @default("oxford_5000") // 数据来源
  source_meta      Json?    // 源数据 Meta (id_book, id_word)

  // 5. 分级策略
  cefrLevel        String?  // A1 - C2
  abceed_level     Int?     // Abceed Level (1-12)
  abceed_rank      Int?     // Sort Order
  definition_jp    String?  // 日文释义 (Reference)
  learningPriority Int      @default(0) // 100(Core), 60(Support), 0(Noise)
  
  // [V1.2] 市场价值分 (Abceed ETL)
  frequency_score  Int      @default(0) // 0-100 用于生存优先排序

  // 向量字段 (1536 维，用于语义搜索)
  embedding Unsupported("vector(1536)")?

  // 关联
  progress         UserProgress[]
  articles         ArticleVocab[]

  @@index([learningPriority])
  @@index([scenarios])
  @@index([frequency_score]) // [V1.2] 生存优先排序索引
}

model UserProgress {
  id        String   @id @default(cuid())
  userId    String
  vocabId   Int
  
  // SRS 调度
  status    LearningStatus @default(NEW) // NEW, LEARNING, REVIEW, MASTERED
  interval  Int            @default(0)   // 天数
  
  // FSRS v5 Fields
  stability      Float    @default(0)
  difficulty     Float    @default(0)
  reps           Int      @default(0)
  lapses         Int      @default(0)
  state          Int      @default(0) // 0=New, 1=Learning, 2=Review, 3=Relearning
  last_review_at DateTime?
  dueDate   DateTime       @default(now())
  
  // @deprecated 旧版五维矩阵 (V/A/M/C/X) - 后续删除
  // { "V": 80, "A": 20, "M": 90, "C": 40, "X": 60 }
  masteryMatrix Json       @default("{}")

  // 语境锚点 (记录上次阅读遇到的句子)
  lastContextSentence String? @db.Text

  // @deprecated [V1.2] 旧版五维认知模型分数 - 后续删除
  // 用于混合取词引擎的高性能筛选 (e.g., 找出 V < 30 或 X < 20 的词)
  dim_v_score    Int       @default(0)  // @deprecated V: Visual Audit
  dim_c_score    Int       @default(0)  // @deprecated C: Drafting
  dim_m_score    Int       @default(0)  // @deprecated M: Decision
  dim_x_score    Int       @default(0)  // @deprecated X: Logic
  dim_a_score    Int       @default(0)  // @deprecated A: Audio

  // ============================================
  // [V2.0 New] 五维记忆系统 (TOEIC Adapted)
  // ============================================
  // 境 (Context): Part5 语法填空
  dim_ctx_score  Int       @default(0)
  // 形 (Visual): 形似词找茬
  dim_vis_score  Int       @default(0)
  // 义 (Meaning): S_V_O 快速语义映射
  dim_mea_score  Int       @default(0)
  // 音 (Audio): 听力 [遗留]
  dim_aud_score  Int       @default(0)
  // 理 (Logic): 同义替换 [遗留]
  dim_log_score  Int       @default(0)
  
  // 维度互斥 (避免连续两次考同维度)
  last_dim_tested String?

  // [V1.2 New] SRS 调度系统
  next_review_at DateTime?              // 下次复习时间
  user      User     @relation(fields: [userId], references: [id])
  vocab     Vocab    @relation(fields: [vocabId], references: [id])

  @@unique([userId, vocabId])
  @@index([userId, dueDate])
  @@index([userId, dim_v_score])      // @deprecated [V1.2] 抢救队列核心索引
  @@index([userId, next_review_at])   // [V1.2] 复习队列核心索引
  @@index([userId, dim_ctx_score])    // [V2.0] 境维度索引
  @@index([userId, dim_vis_score])    // [V2.0] 形维度索引
  @@index([userId, dim_mea_score])    // [V2.0] 义维度索引
}

model Article {
  id          String   @id @default(cuid())
  userId      String
  title       String
  body        Json     // 存储段落结构，方便前端 token 化渲染
  summaryZh   String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  vocabs      ArticleVocab[]
}

model ArticleVocab {
  articleId String
  vocabId   Int
  role      VocabRole // TARGET(新词), CONTEXT(复习词)

  article   Article @relation(fields: [articleId], references: [id])
  vocab     Vocab   @relation(fields: [vocabId], references: [id])

  @@id([articleId, vocabId])
}



model InvitationCode {
  id          String    @id @default(cuid())
  code        String    @unique
  
  // 限制使用次数 (比如给部门同事生成的码，可以设为 20 次)
  maxUses     Int       @default(1) 
  usedCount   Int       @default(0)
  
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // 可选：有效期
}

model User {
  id            String    @id @default(cuid())
  
  // 1. 极简账号信息
  // 对于同事/朋友，Email 是唯一的 ID
  email         String    @unique
  password      String    // bcrypt hash
  name          String?   // 显示名称
  
  // 2. 邀请码关联 (可选，用于记录是谁邀请的，或者使用了哪个码)
  invitedByCode String?   

  // 3. 业务数据 (保持 PRD V1.4 不变)
  timezone      String    @default("Asia/Shanghai") 
  settings      Json?     @default("{}") // { "autoPlay": true }
  
  // 核心资产
  progress      UserProgress[]
  articles      Article[]
  drillCaches   DrillCache[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum LearningStatus {
  NEW
  LEARNING
  REVIEW
  MASTERED
}

enum VocabRole {
  TARGET
  CONTEXT
}

enum VocabPriority {
  CORE
  SUPPORT
  NOISE
}

model DrillCache {
  id        String   @id @default(cuid())
  userId    String
  mode      String   // 'SYNTAX' | 'CHUNKING' | 'NUANCE'
  
  // 存储完整的 AI 生成结果 (BriefingPayload[])
  payload   Json     
  
  isConsumed Boolean @default(false)
  
  createdAt DateTime @default(now())
  expiresAt DateTime // 建议有效期 24h

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, mode, isConsumed])
}

// ============================================
// [V2.0 New] 学习流水日志
// ============================================
// 高吞吐日志表，用于 FSRS 历史重建和数据分析
model StudyLog {
  id        String   @id @default(cuid())
  userId    String
  vocabId   Int
  
  // 题型: S_V_O | VISUAL_TRAP | PART5_CLOZE
  drillType String
  // 维度: CTX | VIS | MEA | AUD | LOG
  dimension String?
  // 结果: PASS | FAIL
  result    String
  // 答题耗时 (毫秒)
  timeSpent Int
  // FSRS 评分 (1-4)
  grade     Int
  
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([vocabId])
  @@index([userId, vocabId])
}
