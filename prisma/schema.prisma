generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vocab {
  // 1. æ ¸å¿ƒæ ‡è¯†
  id               Int      @id @default(autoincrement())
  word             String   @unique

  // 2. åŸºç¡€è¯­æ–™ (From Oxford 5000)
  phoneticUk       String?  // è‹±å¼éŸ³æ ‡
  phoneticUs       String?  // ç¾å¼éŸ³æ ‡
  audioUk          String?  // è‹±å¼éŸ³é¢‘ URL
  partOfSpeech     String?  // è¯æ€§
  commonExample    String?  // é€šç”¨ä¾‹å¥
  
  // 3. è¯­ä¹‰ä¸åœºæ™¯ (AI å¢å¼º)
  // [å…³é”®] å¡ç‰‡å¼ UI ä¸“ç”¨çš„ç®€æ˜ä¸­æ–‡é‡Šä¹‰ (ä» JP æˆ– EN ç¿»è¯‘è€Œæ¥)
  // ç¤ºä¾‹: "æŠ›å¼ƒï¼›ä¸­æ­¢"
  definition_cn    String?  

  // definitions ç»“æ„: [{type: 'general', text: '...'}, {type: 'business', text: '...'}]
  // [å…³é”®] ç»“æ„åŒ–é‡Šä¹‰ (è¯¦æƒ…é¡µç”¨)
  // ç»“æ„: { "business_cn": "ä¼šè®®è®°å½•", "general_cn": "åˆ†é’Ÿ" }
  definitions      Json?     
  
  // [å…³é”®] å•†åŠ¡å±æ€§å¼€å…³ (ç”¨äº Sidebar ç­›é€‰ "Business Only")
  is_toeic_core    Boolean  @default(false)

  scenarios        String[] // å•†åŠ¡åœºæ™¯æ ‡ç­¾ (AI Cleaned)
  
  // collocations ç»“æ„: [{text: '...', trans: '...', source: 'abceed', weight: 100}]
  collocations     Json?     // å¸¸ç”¨æ­é… (AI Generated / Abceed)
  
  // 3.1 AI å¢å¼º Pro Max (ETL V3.0)
  priority         VocabPriority? // ä¼˜å…ˆçº§ (CORE: æ ¸å¿ƒå•†åŠ¡è¯, SUPPORT: æ”¯æ’‘è¯, NOISE: ç®€å•è¯)
  word_family      Json?          // è¯æ—å˜å½¢ { n: "...", v: "..." }
  confusing_words  String[]       // æ˜“æ··æ·†è¯ (Malapropisms)
  synonyms         String[]       // å•†åŠ¡è¿‘ä¹‰è¯
  
  tags             String[] // è‡ªåŠ¨æ ‡ç­¾ (e.g. toeic_900)
  
  // 4. å…ƒæ•°æ®
  source           String   @default("oxford_5000") // æ•°æ®æ¥æº
  source_meta      Json?    // æºæ•°æ® Meta (id_book, id_word)

  // 5. åˆ†çº§ç­–ç•¥
  cefrLevel        String?  // A1 - C2
  abceed_level     Int?     // Abceed Level (1-12)
  abceed_rank      Int?     // Sort Order
  definition_jp    String?  // æ—¥æ–‡é‡Šä¹‰ (Reference)
  learningPriority Int      @default(0) // 100(Core), 60(Support), 0(Noise)
  
  // [V1.2] å¸‚åœºä»·å€¼åˆ† (Abceed ETL)
  frequency_score  Int      @default(0) // 0-100 ç”¨äºç”Ÿå­˜ä¼˜å…ˆæ’åº

  // å‘é‡å­—æ®µ (1536 ç»´ï¼Œç”¨äºè¯­ä¹‰æœç´¢)
  embedding Unsupported("vector(1536)")?

  // å…³è”
  progress         UserProgress[]
  articles         ArticleVocab[]

  @@index([learningPriority])
  @@index([scenarios])
  @@index([frequency_score]) // [V1.2] ç”Ÿå­˜ä¼˜å…ˆæ’åºç´¢å¼•
}

model UserProgress {
  id        String   @id @default(cuid())
  userId    String
  vocabId   Int
  
  // SRS è°ƒåº¦
  status    LearningStatus @default(NEW) // NEW, LEARNING, REVIEW, MASTERED
  interval  Int            @default(0)   // å¤©æ•°
  
  // FSRS v5 Fields
  stability      Float    @default(0)
  difficulty     Float    @default(0)
  reps           Int      @default(0)
  lapses         Int      @default(0)
  state          Int      @default(0) // 0=New, 1=Learning, 2=Review, 3=Relearning
  last_review_at DateTime?
  dueDate   DateTime       @default(now())
  
  // ğŸ”¥ äº”ç»´çŸ©é˜µ (V/A/M/C/X)
  // { "V": 80, "A": 20, "M": 90, "C": 40, "X": 60 }
  masteryMatrix Json       @default("{}")

  // è¯­å¢ƒé”šç‚¹ (è®°å½•ä¸Šæ¬¡é˜…è¯»é‡åˆ°çš„å¥å­)
  lastContextSentence String? @db.Text

  // [V1.2 New] äº”ç»´è®¤çŸ¥æ¨¡å‹åˆ†æ•° (ç‹¬ç«‹å­—æ®µç‰ˆ)
  // ç”¨äºæ··åˆå–è¯å¼•æ“çš„é«˜æ€§èƒ½ç­›é€‰ (e.g., æ‰¾å‡º V < 30 æˆ– X < 20 çš„è¯)
  dim_v_score    Int       @default(0)  // V: Visual Audit
  dim_c_score    Int       @default(0)  // C: Drafting
  dim_m_score    Int       @default(0)  // M: Decision
  dim_x_score    Int       @default(0)  // X: Logic
  dim_a_score    Int       @default(0)  // A: Audio
  
  masteryScore   Int       @default(0)  // ç»¼åˆåˆ†

  // [V1.2 New] SRS è°ƒåº¦ç³»ç»Ÿ
  next_review_at DateTime?              // ä¸‹æ¬¡å¤ä¹ æ—¶é—´
  // Multi-Track FSRS Support
  // æšä¸¾å€¼: "VISUAL" (L0/Syntax), "AUDIO" (L1/Audio), "CONTEXT" (L2/Context)
  track          String    @default("VISUAL")

  user      User     @relation(fields: [userId], references: [id])
  vocab     Vocab    @relation(fields: [vocabId], references: [id])

  // [Breaking Change] å¤åˆä¸»é”®å˜æ›´
  // æœ¬æ¡è®°å½•å”¯ä¸€æ€§ç”± (ç”¨æˆ· + è¯ + è½¨é“) å†³å®š
  // Explicitly map the name to ensure Prisma Client generates the expected input type
  @@unique([userId, vocabId, track], name: "userId_vocabId_track")
  
  @@index([userId, dueDate])
  @@index([userId, dim_v_score])      // [V1.2] æŠ¢æ•‘é˜Ÿåˆ—æ ¸å¿ƒç´¢å¼•
  @@index([userId, next_review_at])   // [V1.2] å¤ä¹ é˜Ÿåˆ—æ ¸å¿ƒç´¢å¼•
  
  // æ–¹ä¾¿ OMPS å¿«é€ŸæŸ¥æ‰¾æŸè½¨é“ä¸‹çš„åˆ°æœŸè¯
  @@index([userId, track, next_review_at])
}

model Article {
  id          String   @id @default(cuid())
  userId      String
  title       String
  body        Json     // å­˜å‚¨æ®µè½ç»“æ„ï¼Œæ–¹ä¾¿å‰ç«¯ token åŒ–æ¸²æŸ“
  summaryZh   String?
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id])
  vocabs      ArticleVocab[]
}

model ArticleVocab {
  articleId String
  vocabId   Int
  role      VocabRole // TARGET(æ–°è¯), CONTEXT(å¤ä¹ è¯)

  article   Article @relation(fields: [articleId], references: [id])
  vocab     Vocab   @relation(fields: [vocabId], references: [id])

  @@id([articleId, vocabId])
}



model InvitationCode {
  id          String    @id @default(cuid())
  code        String    @unique
  
  // é™åˆ¶ä½¿ç”¨æ¬¡æ•° (æ¯”å¦‚ç»™éƒ¨é—¨åŒäº‹ç”Ÿæˆçš„ç ï¼Œå¯ä»¥è®¾ä¸º 20 æ¬¡)
  maxUses     Int       @default(1) 
  usedCount   Int       @default(0)
  
  isActive    Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // å¯é€‰ï¼šæœ‰æ•ˆæœŸ
}

model User {
  id            String    @id @default(cuid())
  
  // 1. æç®€è´¦å·ä¿¡æ¯
  // å¯¹äºåŒäº‹/æœ‹å‹ï¼ŒEmail æ˜¯å”¯ä¸€çš„ ID
  email         String    @unique
  password      String?    // [Fix] Add password field
  name          String?   // æ˜¾ç¤ºåç§°
  
  // 2. é‚€è¯·ç å…³è” (å¯é€‰ï¼Œç”¨äºè®°å½•æ˜¯è°é‚€è¯·çš„ï¼Œæˆ–è€…ä½¿ç”¨äº†å“ªä¸ªç )
  invitedByCode String?   

  // 3. ä¸šåŠ¡æ•°æ® (ä¿æŒ PRD V1.4 ä¸å˜)
  timezone      String    @default("Asia/Shanghai") 
  settings      Json?     @default("{}") // { "autoPlay": true }
  
  // æ ¸å¿ƒèµ„äº§
  progress      UserProgress[]
  articles      Article[]
  drillCaches   DrillCache[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum LearningStatus {
  NEW
  LEARNING
  REVIEW
  MASTERED
}

enum VocabRole {
  TARGET
  CONTEXT
}

enum VocabPriority {
  CORE
  SUPPORT
  NOISE
}

model DrillCache {
  id        String   @id @default(cuid())
  userId    String
  mode      String   // 'SYNTAX' | 'CHUNKING' | 'NUANCE'
  
  // å­˜å‚¨å®Œæ•´çš„ AI ç”Ÿæˆç»“æœ (BriefingPayload[])
  payload   Json     
  
  isConsumed Boolean @default(false)
  
  createdAt DateTime @default(now())
  expiresAt DateTime // å»ºè®®æœ‰æ•ˆæœŸ 24h

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)


  @@index([userId, mode, isConsumed])
}

// ----------------------------------------------------------------------
// [V5.0] Admin Inspector / AI Audit
// ----------------------------------------------------------------------
model DrillAudit {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  
  // Target Information
  targetWord String
  
  // Context & Input
  // æ¨èæ ¼å¼: "L0:SYNTAX" æˆ– "L1:AUDIO"
  contextMode String?
  
  // The full drill object
  payload   Json     
  
  // Audit Result
  status      String // 'GOOD', 'BAD', 'AUDIT', 'PENDING'
  auditScore  Int?
  auditReason String?
  isRedundant Boolean @default(false)
  
  // If 'BAD', manual flagging reason
  flagReason  String?

  // âš¡ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•
  @@index([status])
  @@index([targetWord])
  @@index([createdAt])
}

