# OMPS é€‰è¯å¼•æ“æŠ€æœ¯è§„èŒƒ

> **OMPS** = Opus Mixed-Priority Scheduler  
> ç‰ˆæœ¬: V2.0 (Inventory-First)  
> æ›´æ–°æ—¥æœŸ: 2026-02-07

---

## 1. æ¦‚è¿°

OMPS æ˜¯ Opus ç³»ç»Ÿçš„**æ ¸å¿ƒé€‰è¯å¼•æ“**ï¼Œè´Ÿè´£å†³å®šç”¨æˆ·åœ¨ä»»ä½•å­¦ä¹ åœºæ™¯ä¸­åº”è¯¥å­¦ä¹ /å¤ä¹ å“ªäº›è¯æ±‡ã€‚å®ƒé‡‡ç”¨**Schedule-First**çš„è®¾è®¡å“²å­¦ï¼šå…ˆç¡®å®š"å­¦ä»€ä¹ˆ"ï¼Œå†å†³å®š"æ€ä¹ˆå­¦"ã€‚

### 1.1 è®¾è®¡åŸåˆ™

| åŸåˆ™ | æè¿° |
|:-----|:-----|
| **åº“å­˜ä¼˜å…ˆ (Inventory-First)** | Phase 0: ä¼˜å…ˆé€‰æ‹© Redis ä¸­å·²æœ‰ç¼“å­˜çš„å•è¯ï¼Œé¿å… Fallback |
| **å¤ä¹ ä¼˜å…ˆ (Debt First)** | 70% é…é¢ç»™åˆ°æœŸå¤ä¹ è¯ï¼Œé˜²æ­¢é—å¿˜æ›²çº¿å´©å¡Œ |
| **æ–°è¯åˆ†å±‚ (Stratified New)** | æ–°è¯æŒ‰éš¾åº¦åˆ†å±‚é‡‡æ · (20% ç®€å• / 60% æ ¸å¿ƒ / 20% å›°éš¾) |
| **åŠ¨æ€æº¢å‡º (Spillover)** | å¤ä¹ å€ºåŠ¡ä¸è¶³æ—¶ï¼Œè‡ªåŠ¨å°†é…é¢è½¬ç§»ç»™æ–°è¯ |
| **ç»Ÿä¸€æ¥å£ (Single API)** | Session Drill å’Œ Article Mode å…±ç”¨åŒä¸€é€‰è¯é€»è¾‘ |

### 1.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è°ƒç”¨å±‚ (Consumers)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  actions/get-next-drill.ts   â”‚  lib/services/WordSelectionService.ts
â”‚  (Session Drill Mode)        â”‚  (Article Mode)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                          â”‚
                   â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              lib/services/omps-core.ts                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  fetchOMPSCandidates(userId, limit, config)     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Phase 0: Inventory-First ğŸ†•               â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ getInventoryBackedWords(Redis Scan)   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Phase 1: Macro Scheduler (70/30)           â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ prisma.userProgress.findMany(FSRS)     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Phase 2: Micro Sampler (Stratified)        â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ fetchNewBucket(SIMPLE, 20%)            â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ fetchNewBucket(CORE, 60%)              â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ fetchNewBucket(HARD, 20%)              â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Phase 3: Shuffle & Return                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. API å‚è€ƒ

### 2.1 ä¸»å…¥å£ï¼š`fetchOMPSCandidates`

```typescript
import { fetchOMPSCandidates, OMPSCandidate, OMPSConfig } from '@/lib/services/omps-core';

const candidates: OMPSCandidate[] = await fetchOMPSCandidates(
    userId,      // ç”¨æˆ· ID (CUID)
    limit,       // éœ€è¦çš„è¯æ±‡æ•°é‡
    config?,     // å¯é€‰é…ç½® (è¦†ç›–é»˜è®¤æ¯”ä¾‹)
    excludeIds?  // æ’é™¤çš„è¯æ±‡ ID åˆ—è¡¨
);
```

### 2.2 é…ç½®æ¥å£

```typescript
interface OMPSConfig {
    reviewRatio: number;   // å¤ä¹ é…é¢ (é»˜è®¤ 0.7)
    simpleRatio: number;   // ç®€å•æ–°è¯ (é»˜è®¤ 0.2)
    coreRatio: number;     // æ ¸å¿ƒæ–°è¯ (é»˜è®¤ 0.6)
    hardRatio: number;     // å›°éš¾æ–°è¯ (é»˜è®¤ 0.2)
    posFilter?: string[];  // è¯æ€§è¿‡æ»¤ (å¯é€‰)
}
```

### 2.3 è¿”å›ç±»å‹

```typescript
interface OMPSCandidate {
    vocabId: number;
    word: string;
    definition_cn: string;
    type: 'REVIEW' | 'NEW';  // æ¥æºç±»å‹
    priority_level: number;
    frequency_score: number;
    commonExample: string | null;
    // ... å…¶ä»–å­—æ®µ
}
```

---

## 3. åˆ†å±‚é€»è¾‘è¯¦è§£

### 3.1 Macro Scheduler (å®è§‚è°ƒåº¦)

```
ç”¨æˆ·è¯·æ±‚ 10 ä¸ªè¯æ±‡
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: å¤ä¹ å€ºåŠ¡  â”‚
â”‚  Quota = 70% = 7   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    å®é™…å€ºåŠ¡ = 3
    (åªæœ‰ 3 ä¸ªè¯åˆ°æœŸ)
          â”‚
          â–¼
    Spillover = 7 - 3 = 4
    æ–°è¯é…é¢ = 30% + 4 = 7
```

### 3.2 Micro Sampler (å¾®è§‚é‡‡æ ·)

æ–°è¯æŒ‰ `abceed_level` åˆ†å±‚ï¼š

| Bucket | Level èŒƒå›´ | é…é¢ | é€‰è¯é€»è¾‘ |
|:-------|:-----------|:-----|:---------|
| SIMPLE | 1-3 | 20% | å»ºç«‹ä¿¡å¿ƒï¼Œé™ä½è®¤çŸ¥è´Ÿè· |
| CORE | 4-7 OR `is_toeic_core` | 60% | é«˜ä»·å€¼è¯ï¼Œè€ƒè¯•é«˜é¢‘ |
| HARD | 8+ | 20% | é˜²æ­¢æ— èŠï¼Œä¿æŒæŒ‘æˆ˜ |
| FALLBACK | æ— é™åˆ¶ | 0% | ä»…åœ¨å…¶ä»–æ¡¶è€—å°½æ—¶å¯ç”¨ |

### 3.3 æ’åºä¼˜å…ˆçº§

æ¯ä¸ª Bucket å†…éƒ¨çš„æ’åºï¼š
1. `is_toeic_core: DESC` (æ ¸å¿ƒè¯ä¼˜å…ˆ)
2. `frequency_score: DESC` (é«˜é¢‘è¯ä¼˜å…ˆ)

---

## 4. å¤ç”¨åœºæ™¯

### 4.1 å·²æ¥å…¥åœºæ™¯

| åœºæ™¯ | è°ƒç”¨æ–¹å¼ | é…ç½® |
|:-----|:---------|:-----|
| **Session Drill (SYNTAX)** | `fetchOMPSCandidates(userId, 10, { posFilter: ['v', 'n', ...] })` | è¯æ€§è¿‡æ»¤å¯ç”¨ |
| **Session Drill (PHRASE)** | `fetchOMPSCandidates(userId, 10)` | é»˜è®¤é…ç½® |
| **Article Mode** | `fetchOMPSCandidates(userId, 1)` + `ContextSelector` | è·å– 1 ä¸ªä¸»è§’è¯ |

### 4.2 å»ºè®®æ¥å…¥åœºæ™¯

ä»¥ä¸‹åœºæ™¯åœ¨æœªæ¥å¼€å‘æ—¶**å¿…é¡»**ä½¿ç”¨ OMPSï¼š

- [ ] **Daily Challenge**: æ¯æ—¥æŒ‘æˆ˜è¯æ±‡é€‰å–
- [ ] **Review Session**: ä¸“é¡¹å¤ä¹ æ¨¡å¼
- [ ] **Vocabulary List**: ç”¨æˆ·è¯æ±‡è¡¨æ’åº
- [ ] **Push Notification**: å¤ä¹ æé†’è¯æ±‡é€‰å–

### 4.3 ä¸é€‚ç”¨åœºæ™¯

ä»¥ä¸‹åœºæ™¯**ç¦æ­¢**ä½¿ç”¨ OMPSï¼š

- âŒ **Context Words é€‰å–**: ä½¿ç”¨ `ContextSelector` (è¯­ä¹‰ç›¸ä¼¼æ€§)
- âŒ **Distractor ç”Ÿæˆ**: ä½¿ç”¨ `DistractorSelector` (è§†è§‰/è¯­ä¹‰å†²çª)

---

## 5. å¼€å‘è§„èŒƒ

### 5.1 æ–°å¢åœºæ™¯æ¥å…¥

1. **å¯¼å…¥å…±äº«æ¨¡å—**ï¼š
   ```typescript
   import { fetchOMPSCandidates } from '@/lib/services/omps-core';
   ```

2. **ä¼ é€’æ­£ç¡®çš„ excludeIds**ï¼š
   ```typescript
   // ç¡®ä¿ä¸è¿”å›ç”¨æˆ·æœ¬æ¬¡ä¼šè¯å·²è§è¿‡çš„è¯
   const candidates = await fetchOMPSCandidates(userId, limit, {}, alreadySeenIds);
   ```

3. **å¤„ç†ç©ºç»“æœ**ï¼š
   ```typescript
   if (candidates.length === 0) {
       // æç¤ºç”¨æˆ·è¯åº“å·²å­¦å®Œï¼Œæˆ–é™çº§åˆ°éšæœºé€‰è¯
   }
   ```

### 5.2 é…ç½®è¦†ç›–

å¦‚éœ€è°ƒæ•´é…æ¯”ï¼ˆéœ€äº§å“ç¡®è®¤ï¼‰ï¼š

```typescript
// ä¾‹ï¼šå¤ä¹ ä¸“é¡¹æ¨¡å¼ (100% å¤ä¹ ï¼Œ0% æ–°è¯)
const reviewOnlyCandidates = await fetchOMPSCandidates(userId, 20, {
    reviewRatio: 1.0,
    simpleRatio: 0,
    coreRatio: 0,
    hardRatio: 0
});
```

### 5.3 æµ‹è¯•è¦æ±‚

æ–°å¢è°ƒç”¨æ–¹å¿…é¡»ç¼–å†™ä»¥ä¸‹æµ‹è¯•ï¼š

1. **Mock OMPS è¿”å›å€¼**ï¼šä¸è¦æµ‹è¯• OMPS å†…éƒ¨é€»è¾‘ï¼ˆå·²è¦†ç›–ï¼‰
2. **éªŒè¯ excludeIds ä¼ é€’**ï¼šç¡®ä¿æ— é‡å¤è¯
3. **éªŒè¯ç©ºç»“æœå¤„ç†**ï¼šè¾¹ç•Œæƒ…å†µ

---

## 6. æµ‹è¯•ä¸ä»¿çœŸ

### 6.1 å•å…ƒæµ‹è¯•

```bash
npm test lib/services/__tests__/omps-core.test.ts
```

æµ‹è¯•å¥—ä»¶è¦†ç›–ï¼š
- Suite A: Macro Scheduler (4 ç”¨ä¾‹)
- Suite B: Micro Sampler (4 ç”¨ä¾‹)
- Suite C: Edge Cases (5 ç”¨ä¾‹)
- Suite D: Integration (3 ç”¨ä¾‹)

### 6.2 ä»¿çœŸæµ‹è¯•

```bash
npx tsx scripts/sim-omps-full.ts --userId=<cuid> --batches=10
```

è¾“å‡ºæŠ¥å‘ŠåŒ…å«ï¼š
- æ€»ä½“ç»Ÿè®¡ (æ€»æ•°/å”¯ä¸€/é‡å¤)
- æ¥æºåˆ†å¸ƒ (cache/fallback)
- æ‰¹æ¬¡è¯¦æƒ…

---

## 7. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆ 100% éƒ½æ˜¯ `deterministic_fallback`ï¼Ÿ

**A**: è¿™æ˜¯å†·å¯åŠ¨çš„æ­£å¸¸è¡¨ç°ã€‚Redis ç¼“å­˜ä¸ºç©ºæ—¶ï¼Œç³»ç»Ÿä½¿ç”¨ç¡®å®šæ€§å…œåº•ç¡®ä¿ç”¨æˆ·ä¸ç­‰å¾…ã€‚åå°ä»»åŠ¡ (Batch Emergency) ä¼šè‡ªåŠ¨è¡¥è´§ï¼Œä¸‹æ¬¡è¯·æ±‚å°†å‘½ä¸­ç¼“å­˜ã€‚

### Q2: å¦‚ä½•éªŒè¯å¤ä¹ ä¼˜å…ˆçº§æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

**A**: è¿è¡Œä»¿çœŸè„šæœ¬å¹¶æ£€æŸ¥æ—¥å¿—ä¸­çš„ `reviewCount` / `newCount`ï¼š
```
[INFO] OMPS candidates fetched { reviewCount: 7, newCount: 3 }
```
å¦‚æœ `reviewCount > 0`ï¼Œè¯´æ˜æœ‰å¤ä¹ å€ºåŠ¡è¢«ä¼˜å…ˆé€‰ä¸­ã€‚

### Q3: æ–°è¯çš„åˆ†å±‚æ¯”ä¾‹å¯ä»¥è°ƒæ•´å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½†éœ€äº§å“ç¡®è®¤ã€‚é€šè¿‡ `OMPSConfig` ä¼ å…¥è‡ªå®šä¹‰æ¯”ä¾‹ï¼š
```typescript
{ simpleRatio: 0.1, coreRatio: 0.8, hardRatio: 0.1 }
```

---

## 8. å˜æ›´æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|:-----|:-----|:-----|
| V1.0 | 2026-01-28 | åˆå§‹å®ç°ï¼Œé›†æˆåˆ° `get-next-drill.ts` |
| V1.1 | 2026-01-28 | æŠ½å–ä¸ºå…±äº«æ¨¡å— `omps-core.ts`ï¼ŒArticle Mode æ¥å…¥ |
| V2.0 | 2026-02-07 | æ–°å¢ Phase 0 (Inventory-First)ï¼Œä¼˜å…ˆé€‰æ‹©æœ‰ç¼“å­˜çš„å•è¯ |
